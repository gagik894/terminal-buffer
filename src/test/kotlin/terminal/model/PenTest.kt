package terminal.model

import com.gagik.terminal.codec.AttributeCodec
import com.gagik.terminal.model.Pen
import org.junit.jupiter.api.Assertions.*
import org.junit.jupiter.api.DisplayName
import org.junit.jupiter.api.Nested
import org.junit.jupiter.api.Test
import org.junit.jupiter.params.ParameterizedTest
import org.junit.jupiter.params.provider.CsvSource

@DisplayName("Pen")
class PenTest {

    @Nested
    @DisplayName("Initialization")
    inner class InitializationTests {

        @Test
        fun `initializes with default attributes`() {
            val pen = Pen()
            val expected = AttributeCodec.pack(0, 0, bold = false, italic = false, underline = false)
            assertEquals(expected, pen.currentAttr, "Pen should initialize with default attributes (0, 0, no styles)")
        }
    }

    @Nested
    @DisplayName("setAttributes()")
    inner class SetAttributesTests {

        @ParameterizedTest(name = "fg={0}, bg={1}")
        @CsvSource(
            "0, 0",       // Default
            "1, 1",       // ANSI black
            "8, 8",       // Bright colors
            "16, 16"      // Max valid
        )
        fun `sets valid colors`(fg: Int, bg: Int) {
            val pen = Pen()
            pen.setAttributes(fg, bg, bold = false, italic = false, underline = false)

            val expected = AttributeCodec.pack(fg, bg, bold = false, italic = false, underline = false)
            assertEquals(expected, pen.currentAttr, "Colors should be set correctly in the packed attributes")
        }

        @ParameterizedTest(name = "fg={0}, bg={1} -> clamped to ({2}, {3})")
        @CsvSource(
            "-1, 0, 0, 0",        // Negative fg
            "0, -1, 0, 0",        // Negative bg
            "17, 0, 16, 0",       // Overflow fg
            "0, 100, 0, 16",      // Overflow bg
            "-10, 100, 0, 16"     // Both out of bounds
        )
        fun `clamps out of bounds colors`(fg: Int, bg: Int, expectedFg: Int, expectedBg: Int) {
            val pen = Pen()
            pen.setAttributes(fg, bg, bold = false, italic = false, underline = false)

            val expected = AttributeCodec.pack(expectedFg, expectedBg, bold = false, italic = false, underline = false)
            assertEquals(expected, pen.currentAttr, "Colors should be clamped to valid range (0-16)")
        }

        @ParameterizedTest(name = "bold={0}, italic={1}, underline={2}")
        @CsvSource(
            "true, false, false",
            "false, true, false",
            "false, false, true",
            "true, true, true",
            "false, false, false"
        )
        fun `sets style flags`(bold: Boolean, italic: Boolean, underline: Boolean) {
            val pen = Pen()
            pen.setAttributes(fg = 7, bg = 0, bold = bold, italic = italic, underline = underline)

            val expected = AttributeCodec.pack(7, 0, bold = bold, italic = italic, underline = underline)
            assertEquals(expected, pen.currentAttr, "Style flags should be set correctly in the packed attributes")
        }

        @Test
        fun `overwrites previous attributes`() {
            val pen = Pen()
            pen.setAttributes(fg = 1, bg = 2, bold = true, italic = false, underline = false)
            pen.setAttributes(fg = 3, bg = 4, bold = false, italic = true, underline = true)

            val expected = AttributeCodec.pack(3, 4, bold = false, italic = true, underline = true)
            assertEquals(expected, pen.currentAttr, "New attributes should overwrite previous ones completely")
        }

        @Test
        fun `handles extreme values`() {
            val pen = Pen()
            pen.setAttributes(Int.MAX_VALUE, Int.MIN_VALUE, bold = true, italic = true, underline = true)

            val expected = AttributeCodec.pack(16, 0, bold = true, italic = true, underline = true)
            assertEquals(expected, pen.currentAttr, "Should clamp extreme values to valid range")
        }
    }

    @Nested
    @DisplayName("reset()")
    inner class ResetTests {

        @Test
        fun `resets to default`() {
            val pen = Pen()
            pen.setAttributes(fg = 10, bg = 10, bold = true, italic = true, underline = true)
            pen.reset()

            val expected = AttributeCodec.pack(0, 0, bold = false, italic = false, underline = false)
            assertEquals(expected, pen.currentAttr, "Reset should return attributes to default state")
        }

        @Test
        fun `reset is idempotent`() {
            val pen = Pen()
            pen.setAttributes(fg = 5, bg = 5, bold = true, italic = true, underline = true)
            pen.reset()
            val first = pen.currentAttr
            pen.reset()
            val second = pen.currentAttr

            assertEquals(first, second, "Reset should be idempotent, multiple calls should yield the same result")
        }

        @Test
        fun `can set attributes after reset`() {
            val pen = Pen()
            pen.setAttributes(fg = 5, bg = 10, bold = true, italic = false, underline = true)
            pen.reset()
            pen.setAttributes(fg = 3, bg = 7, bold = false, italic = true, underline = false)

            val expected = AttributeCodec.pack(3, 7, bold = false, italic = true, underline = false)
            assertEquals(expected, pen.currentAttr, "Attributes should be settable after reset")
        }
    }
}